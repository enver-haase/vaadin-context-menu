<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../../iron-test-helpers/iron-test-helpers.html">
    <link rel="import" href="../../test-fixture/test-fixture.html">
    <link rel="import" href="external-imports.html">
    <link rel="import" href="../vaadin-context-menu.html">
    <link rel="import" href="not-animated-styles.html">
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <script src="common.js"></script>
  </head>
  <body>
    <test-fixture id="default">
      <template>
        <vaadin-context-menu>
          <template>
            <vaadin-list-box id="menu">
              <vaadin-item>item1</vaadin-item>
              <vaadin-item>item2</vaadin-item>
              <vaadin-item>item3</vaadin-item>
            </vaadin-list-box>
          </template>
        </vaadin-context-menu>
      </template>
    </test-fixture>

    <script>
      describe('overlay', () => {

        const ios = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        let menu, overlay;

        beforeEach(() => {
          menu = fixture('default');
          overlay = menu.$.overlay;
        });

        describe('selection', () => {

          it('should close on item tap', done => {
            listenOnce(overlay, 'vaadin-overlay-open', () => {
              const listBox = overlay.content.querySelector('#menu');
              Polymer.RenderStatus.afterNextRender(listBox, () => {
                MockInteractions.tap(listBox.items[0]);
                expect(menu.opened).to.eql(false);
                done();
              });
            });

            menu._setOpened(true);
          });

          it('should close on keyboard selection', done => {
            listenOnce(overlay, 'vaadin-overlay-open', () => {
              setTimeout(() => {
                listenOnce(menu, 'opened-changed', () => {
                  done();
                });

                const item = overlay.content.querySelector('#menu vaadin-item');
                MockInteractions.pressAndReleaseKeyOn(item, 13, [], 'Enter');
              }, 10);
            });

            menu._setOpened(true);
          });

          it('should focus the overlay element', done => {
            listenOnce(overlay, 'vaadin-overlay-open', () => {
              Polymer.Async.timeOut.run(() => {
                expect(overlay._getActiveElement()).to.eql(overlay.$.overlay);
                done();
              });
            });

            menu._setOpened(true);
          });

          // FIXME(web-padawan): timeout in Sauce on iOS 11.3
          (ios ? it.skip : it)('should focus the overlay element on `contextmenu` event', done => {
            listenOnce(overlay, 'vaadin-overlay-open', () => {
              Polymer.Async.timeOut.run(() => {
                expect(overlay._getActiveElement()).to.eql(overlay.$.overlay);
                done();
              });
            });

            fire(menu, 'contextmenu');
          });

          (ios ? it.skip : it)('should focus the child element on `keydown` event', done => {
            menu.openOn = 'keydown';
            listenOnce(overlay, 'vaadin-overlay-open', () => {
              Polymer.Async.timeOut.run(() => {
                const item = overlay.content.querySelector('#menu vaadin-item');
                expect(overlay._getActiveElement()).to.eql(item);
                done();
              });
            });

            fire(menu, 'keydown', {}, {keyCode: 40, key: 'ArrowDown'});
          });

          (ios ? it.skip : it)('should focus the last item element on Arrow Up `keydown` event', done => {
            menu.openOn = 'keydown';
            listenOnce(overlay, 'vaadin-overlay-open', () => {
              Polymer.Async.timeOut.run(() => {
                const items = overlay.content.querySelectorAll('#menu vaadin-item');
                expect(overlay._getActiveElement()).to.eql(items[items.length - 1]);
                done();
              });
            });

            fire(menu, 'keydown', {}, {keyCode: 38, key: 'ArrowUp'});
          });
        });
      });
    </script>

  </body>
</html>
